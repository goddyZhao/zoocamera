var app=angular.module("zoopervisor",["ngRoute","ngSanitize","ngAnimate","app.services","ui.tree","ui.ace","ui.select"]).config(["$routeProvider","$locationProvider",function(a,b){"use strict";a.when("/",{templateUrl:"/templates/app.html",controller:"AppController"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).run(["$rootScope","$document",function(a,b){"use strict";if(a.zookeepers=[],a.notifcationInterval=1500,a.token=b[0].querySelector('meta[name="csrf-token"]').getAttribute("content"),a.isLogin="yes"===b[0].querySelector('meta[name="isLogin"]').getAttribute("content").toLowerCase(),a.isLogin){var c=b[0].querySelector('meta[name="zookeeperServerUrl"]').getAttribute("content").split(":");a.zookeeper={host:c[0],port:c[1]}}a.team=[{name:"Goddy Zhao",duty:"backend",avatar:"https://avatars3.githubusercontent.com/u/164988",github:"https://github.com/goddyZhao"},{name:"Wright Liu",duty:"backend",avatar:"https://avatars3.githubusercontent.com/u/4536544",github:"https://github.com/touwang"},{name:"Jacob Zhang",duty:"ui",avatar:"https://avatars1.githubusercontent.com/u/1867889",github:"https://github.com/judas1017"},{name:"Lu, Ke",duty:"ui",avatar:"https://avatars2.githubusercontent.com/u/558673",github:"https://github.com/lukeupup"}]}]);app.controller("AppController",["$scope","$http","$timeout","$rootScope",function(a,b,c,d){a.popup={},a.notification={content:"",type:""},a.templates={node:"/templates/node.html",editor:"/templates/editor.html"},a.disconnect=function(){a.$emit("disconnect")},a.showTeam=function(){a.$emit("popup",{header:"Hello team",template:"/templates/team.html",data:{team:d.team}})},a.$on("popup",function(b,c){a.popup=c,a.animations.popup=!0}),a.$on("node.selecting",function(c,d){if(a.closePopup(),d){if(a.selectedNode!==d.id)if(a.isEditing)a.$broadcast("node.content.unsaved",d);else{var f=("/"===d.path?"":d.path)+"/"+d.title,g="/api/nodes/"+encodeURIComponent(f);b({method:"GET",url:g}).success(function(b){b.success&&b.data?(a.selectedNode=d.id,a.$broadcast("node.selected",{node:d,data:b.data})):(a.selectedNode=null,e({type:"failure",content:"Cannot get node content!"}))}).error(function(){a.selectedNode=null,e({type:"failure",content:"Cannot get node content!"})})}}else a.selectedNode=null}),a.$on("node.creating",function(c,f){var g={path:f.path,_csrf:d.token};a.closePopup(),b({method:"POST",url:"/api/nodes",data:g}).success(function(b){b.success&&b.data?(e({type:"success",content:"Node added!"}),a.$broadcast("node.created",{scope:f.scope,node:{id:b.data.node.id,title:f.name,path:f.path.slice(0,f.path.lastIndexOf("/"))}})):e({type:"failure",content:"Add action failed"})}).error(function(){e({type:"failure",content:"Add action failed"})})}),a.$on("node.removing",function(c,f){var g="/api/nodes/"+encodeURIComponent(f.path),h={_method:"delete",_csrf:d.token};a.closePopup(),b({method:"POST",url:g,data:h}).success(function(b){b.success?(e({type:"success",content:"Node removed!"}),a.$broadcast("node.removed",{scope:f.scope})):e({type:"failure",content:"Remove action failed!"})}).error(function(){e({type:"failure",content:"Remove action failed!"})})}),a.$on("node.updating",function(c,f){var g="/api/nodes/"+encodeURIComponent(f.path),h={_method:"put",_csrf:d.token,data:f.data};b({method:"POST",url:g,data:h}).success(function(b){b.success?(e({type:"success",content:"Node content updated!"}),a.$broadcast("node.updated")):e({type:"failure",content:"Update node content failed!"})}).error(function(){e({type:"failure",content:"Update node content failed!"})})}),a.$on("node.editing",function(b,c){a.isEditing=c}),a.closePopup=function(){a.animations.popup=!1,a.popup={}};var e=function(b){a.notification.type=b.type,a.notification.content=b.content,a.animations.notification=!0,c(function(){a.animations.notification=!1},d.notifcationInterval)}}]),app.controller("EditorController",["$scope",function(a){var b,c="";a.editorContent="",a.aceLoaded=function(a){b=a},a.edit=function(){c=a.editorContent,a.editing=!0,a.$emit("node.editing",a.editing),b.focus()},a.cancel=function(){a.$emit("editor.restore",{restoreValue:!0})},a.save=function(){a.editing=!1,a.$emit("node.updating",{path:a.path,data:a.editorContent})},a.syntax={},a.syntaxes=[{title:"Plain Text",name:"plain_text"},{title:"XML",name:"xml"},{title:"JSON",name:"json"}],a.syntax.selected=a.syntaxes[0],a.mode={},a.modes=[{title:"Normal",name:""},{title:"VIM",name:"vim"},{title:"Emacs",name:"emacs"}],a.$on("node.updated",function(){a.$emit("editor.restore")}),a.$on("node.selected",function(b,c){a.path=("/"===c.node.path?"":c.node.path)+"/"+c.node.title,a.editorContent=c.data.data?c.data.data:""}),a.$on("node.content.unsaved",function(b,c){a.$emit("popup",{header:"Unsaved modification",content:'You have <span class="alert">UNSAVED</span> modification in the editor.',buttons:[{type:"close",icon:"cancel",text:"cancel"},{type:"submit",icon:"ok",text:"Discard"}],submit:function(){a.$emit("editor.restore",{restoreValue:!0}),a.$emit("node.selecting",c)}})}),a.$on("editor.restore",function(b,d){d&&d.restoreValue&&(a.editorContent=c),a.editing=!1,a.$emit("node.editing",a.editing)}),a.$watch("mode.selected",function(a){var c=a&&a.name||"";c?b.setKeyboardHandler("ace/keyboard/"+c):b.setKeyboardHandler(),b.focus()}),a.$watch("syntax.selected",function(a){var c=a&&a.name||"plain_text";b.getSession().setMode("ace/mode/"+c),b.focus()}),a.$watch("editing",function(a){var c=!a;b.setOptions({readOnly:c,highlightActiveLine:!c,highlightGutterLine:!c}),b.renderer.$cursorLayer.element.style.opacity=c?0:100})}]),app.controller("MainController",["$scope","$rootScope","$http","$timeout",function(a,b,c,d){a.animations={load:!1,login:!1,popup:!1,notification:!1},a.zookeeper={host:"",port:""},a.submit=function(){var e={host:a.zookeeper.host,port:a.zookeeper.port,_csrf:b.token};a.animations.load=!0,c({method:"POST",url:"/api/connects",data:e}).success(function(b){a.connectFailed=!1,a.animations.load=!1,b.data&&b.data.success?(d(function(){a.$broadcast("tree.fetch")},1e3),a.zookeepers[0]=a.zookeeper,a.animations.login=!0):a.connectFailed=!0}).error(function(){a.connectFailed=!0})},b.isLogin&&(a.animations.login=!0,a.zookeeper.host=b.zookeeper.host,a.zookeeper.port=b.zookeeper.port,a.zookeepers[0]=a.zookeeper),a.$on("disconnect",function(){window.location="/"})}]),app.controller("NodeController",["$scope","$http","$rootScope","_",function(a,b,c,d){var e=function(a,b){return angular.forEach(a,function(a){b?a.path=b:(a.path="/",b=""),a.items.length>0&&e(a.items,b+"/"+a.title)}),a},f=function(a,b,c,e){return a.length>0&&b&&angular.forEach(a,function(a){var g=d.clone(c)||[];a.hit=a.title.toLowerCase().indexOf(b.toLowerCase())>-1,a.search=e||a.hit||!1,a.hit&&angular.forEach(c||[],function(a){a.search=!0}),a.items.length>0&&(g.push(a),f(a.items,b,g,a.hit||e))}),a},g=function(){b({method:"GET",url:"/api/nodes"}).success(function(b){b.success&&b.data&&(a.nodes=e(b.data.nodes),a.current=a.nodes,a.mode="show")})},h=function(){c.isLogin&&a.$emit("tree.fetch")};a.searchPattern="",a.searchNode=function(){a.mode="search",a.searching=!0,a.current=[],a.$emit("node.selecting",null),a.searchPattern||(a.mode="show"),a.current=f(a.nodes,a.searchPattern,null),a.searching=!1},a.options={},a.toggle=function(a){a.toggle()},a.select=function(b){a.$emit("node.selecting",b)},a.removeItem=function(b,c,d){d.stopPropagation(),a.$emit("popup",{header:"Please confirm",content:'Are you sure you want to <span class="alert">REMOVE</span> this node from zookeeper?',buttons:[{type:"close",icon:"cancel",text:"cancel"},{type:"submit",icon:"ok",text:"remove"}],submit:function(){a.$emit("node.removing",{scope:b,path:("/"===c.path?"":c.path)+"/"+c.title})}})},a.newSubItem=function(b,c,d){d.stopPropagation(),a.$emit("popup",{header:"Enter node name",template:"/templates/nodeAddDialogue.html",buttons:[{type:"close",icon:"cancel",text:"cancel"},{type:"submit",icon:"ok",text:"apply"}],submit:function(d,e){e.popupForm.$valid&&a.$emit("node.creating",{scope:b,path:("/"===c.path?"":c.path)+"/"+c.title+"/"+d.nodeName,name:d.nodeName})}})},a.$on("node.created",function(a,b){var c=b.scope,d=c.$modelValue;d.items.push({id:b.node.id,title:b.node.title,path:b.node.path,items:[],search:!0})}),a.$on("node.removed",function(a,b){b.scope.remove()}),a.$on("tree.fetch",function(){g()}),h()}]),app.directive("zooNotification",function(){return{restrict:"EA",scope:{content:"=notiContent",type:"=notiType"},templateUrl:"/templates/notification.html"}}),app.directive("zooPopup",function(){return{restrict:"EA",scope:{popup:"=popup",close:"&onClose"},templateUrl:"/templates/popup.html",link:function(a){a.$watch("popup",function(){var b=a.popup.data;b&&angular.forEach(b,function(b,c){a[c]=b}),a.model={}})}}}),angular.module("app.services",[]).factory("_",[function(){return window._}]);